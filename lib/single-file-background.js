!function(){"use strict";"undefined"==typeof globalThis&&(window.globalThis=window),(()=>{if(!globalThis.browser&&globalThis.chrome){const e=globalThis.chrome;globalThis.__defineGetter__("browser",(()=>({action:{onClicked:{addListener:t=>e.action.onClicked.addListener(t)},setBadgeText:t=>e.action.setBadgeText(t),setBadgeBackgroundColor:t=>e.action.setBadgeBackgroundColor(t),setTitle:t=>e.action.setTitle(t),setIcon:t=>e.action.setIcon(t)},bookmarks:{get:t=>e.bookmarks.get(t),onCreated:{addListener:t=>e.bookmarks.onCreated.addListener(t),removeListener:t=>e.bookmarks.onCreated.removeListener(t)},onChanged:{addListener:t=>e.bookmarks.onChanged.addListener(t),removeListener:t=>e.bookmarks.onChanged.removeListener(t)},onMoved:{addListener:t=>e.bookmarks.onMoved.addListener(t),removeListener:t=>e.bookmarks.onMoved.removeListener(t)},update:(t,r)=>e.bookmarks.update(t,r)},commands:{onCommand:{addListener:t=>e.commands.onCommand.addListener(t)}},downloads:{download:t=>e.downloads.download(t),onChanged:{addListener:t=>e.downloads.onChanged.addListener(t),removeListener:t=>e.downloads.onChanged.removeListener(t)},search:t=>e.downloads.search(t)},i18n:{getMessage:(t,r)=>e.i18n.getMessage(t,r)},identity:{getRedirectURL:()=>e.identity.getRedirectURL(),getAuthToken:t=>e.identity.getAuthToken(t),launchWebAuthFlow:t=>e.identity.launchWebAuthFlow(t),removeCachedAuthToken:t=>e.identity.removeCachedAuthToken(t)},contextMenus:{onClicked:{addListener:t=>e.contextMenus.onClicked.addListener(t)},create:t=>e.contextMenus.create(t),update:(t,r)=>e.contextMenus.update(t,r),removeAll:()=>e.contextMenus.removeAll()},permissions:{request:t=>e.permissions.request(t),remove:t=>e.permissions.remove(t)},runtime:{id:e.runtime.id,sendNativeMessage:(t,r)=>new Promise(((n,a)=>{e.runtime.sendNativeMessage(t,r,(t=>{e.runtime.lastError?a(e.runtime.lastError):n(t)}))})),getManifest:()=>e.runtime.getManifest(),onMessage:{addListener:t=>e.runtime.onMessage.addListener(((e,r,n)=>{const a=t(e,r);if(a&&"function"==typeof a.then)return a.then((e=>{if(void 0!==e)try{n(e)}catch(e){}})),!0})),removeListener:t=>e.runtime.onMessage.removeListener(t)},onMessageExternal:{addListener:t=>e.runtime.onMessageExternal.addListener(((e,r,n)=>{const a=t(e,r);if(a&&"function"==typeof a.then)return a.then((e=>{if(void 0!==e)try{n(e)}catch(e){}})),!0}))},sendMessage:t=>new Promise(((r,n)=>{e.runtime.sendMessage(t,(t=>{e.runtime.lastError?n(e.runtime.lastError):r(t)})),e.runtime.lastError&&n(e.runtime.lastError)})),getURL:t=>e.runtime.getURL(t),getContexts:t=>e.runtime.getContexts(t),get lastError(){return e.runtime.lastError}},scripting:{executeScript:t=>e.scripting.executeScript(t)},storage:{local:{set:t=>e.storage.local.set(t),get:t=>e.storage.local.get(t),clear:()=>e.storage.local.clear(),remove:t=>e.storage.local.remove(t)},sync:{set:t=>e.storage.sync.set(t),get:t=>e.storage.sync.get(t),clear:()=>e.storage.sync.clear(),remove:t=>e.storage.sync.remove(t)}},tabs:{onCreated:{addListener:t=>e.tabs.onCreated.addListener(t)},onActivated:{addListener:t=>e.tabs.onActivated.addListener(t)},onUpdated:{addListener:t=>e.tabs.onUpdated.addListener(t),removeListener:t=>e.tabs.onUpdated.removeListener(t)},onRemoved:{addListener:t=>e.tabs.onRemoved.addListener(t),removeListener:t=>e.tabs.onRemoved.removeListener(t)},onReplaced:{addListener:t=>e.tabs.onReplaced.addListener(t),removeListener:t=>e.tabs.onReplaced.removeListener(t)},captureVisibleTab:(t,r)=>e.tabs.captureVisibleTab(t,r),sendMessage:(t,r,n={})=>new Promise(((a,s)=>{e.tabs.sendMessage(t,r,n,(t=>{e.runtime.lastError?s(e.runtime.lastError):a(t)})),e.runtime.lastError&&s(e.runtime.lastError)})),query:t=>e.tabs.query(t),create:t=>e.tabs.create(t),get:t=>e.tabs.get(t),remove:t=>e.tabs.remove(t),update:(t,r)=>e.tabs.update(t,r)},devtools:{inspectedWindow:{onResourceContentCommitted:{addListener:t=>e.devtools.inspectedWindow.onResourceContentCommitted.addListener(t)},get tabId(){return e.devtools.inspectedWindow.tabId}}},offscreen:{createDocument:t=>e.offscreen.createDocument(t)},declarativeNetRequest:{updateSessionRules:t=>e.declarativeNetRequest.updateSessionRules(t)}})))}})();const e=8388608;let t=1;async function r(t,r,n){for(let a=0;a*e<=n.array.length;a++){const s={method:"singlefile.fetchResponse",requestId:r,headers:n.headers,status:n.status,error:n.error};s.truncated=n.array.length>e,s.truncated?(s.finished=(a+1)*e>n.array.length,s.array=n.array.slice(a*e,(a+1)*e)):s.array=n.array,await browser.tabs.sendMessage(t,s)}return{}}async function n(e,r){const n=t++;return await browser.declarativeNetRequest.updateSessionRules({addRules:[{action:{type:"modifyHeaders",requestHeaders:[{header:"Referer",operation:"set",value:r}]},condition:{initiatorDomains:[browser.runtime.id],urlFilter:e,resourceTypes:["xmlhttprequest"]},id:n}]}),n}browser.runtime.onMessage.addListener(((e,t)=>{if(e.method&&e.method.startsWith("singlefile.fetch"))return new Promise((a=>{(async function(e,t){if("singlefile.fetch"==e.method)try{const a=await async function(e,t={}){const r=await fetch(e,t);if(t.referrer&&401==r.status||403==r.status||404==r.status){const r=await n(e,t.referrer);await new Promise((e=>setTimeout(e,1e3)));try{const r=await fetch(e,t),n=Array.from(new Uint8Array(await r.arrayBuffer())),a={"content-type":r.headers.get("content-type")};return{array:n,headers:a,status:r.status}}finally{await async function(e){await browser.declarativeNetRequest.updateSessionRules({removeRuleIds:[e]})}(r)}}const a=Array.from(new Uint8Array(await r.arrayBuffer())),s={"content-type":r.headers.get("content-type")},o=r.status;return{array:a,headers:s,status:o}}(e.url,{referrer:e.referrer,headers:e.headers});return r(t.tab.id,e.requestId,a)}catch(n){return r(t.tab.id,e.requestId,{error:n.message,array:[]})}else if("singlefile.fetchFrame"==e.method)return browser.tabs.sendMessage(t.tab.id,e)})(e,t).then(a).catch((e=>a({error:e&&e.toString()})))}))})),browser.runtime.onMessage.addListener(((e,t)=>{if("singlefile.frameTree.initResponse"==e.method||"singlefile.frameTree.ackInitRequest"==e.method)return browser.tabs.sendMessage(t.tab.id,e,{frameId:0}),Promise.resolve({})}));const a=new Map;function s(e,t){e.delete(t)}browser.runtime.onMessage.addListener(((e,t)=>{if("singlefile.lazyTimeout.setTimeout"==e.method){let r,n=a.get(t.tab.id);if(n)if(r=n.get(t.frameId),r){const t=r.get(e.type);t&&clearTimeout(t)}else r=new Map;const o=setTimeout((async()=>{try{const r=a.get(t.tab.id),n=r.get(t.frameId);r&&n&&s(n,e.type),await browser.tabs.sendMessage(t.tab.id,{method:"singlefile.lazyTimeout.onTimeout",type:e.type})}catch(e){}}),e.delay);return n||(n=new Map,r=new Map,n.set(t.frameId,r),a.set(t.tab.id,n)),r.set(e.type,o),Promise.resolve({})}if("singlefile.lazyTimeout.clearTimeout"==e.method){let r=a.get(t.tab.id);if(r){const n=r.get(t.frameId);if(n){const t=n.get(e.type);t&&clearTimeout(t),s(n,e.type)}}return Promise.resolve({})}})),browser.tabs.onRemoved.addListener((e=>a.delete(e)));async function o(e){const t=await crypto.subtle.digest({name:"SHA-256"},e);return function(e){const t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],r=new Array(256);for(let e=0;e<256;e++)r[e]=`${t[e>>>4&15]}${t[15&e]}`;let n="";for(let t=0,a=e.length;t<a;t++)n+=r[e[t]];return n}(new Uint8Array(t))}function i(e){switch(e){case"pdf":return"application/pdf";case"html":return"text/html";default:throw new Error(`Unsupported file type: ${e}`)}}console.log("background.js");(async()=>{const e=await chrome.cookies.get({url:"https://api-dev.macro.com",name:"sessionId"});console.log(e)})();const d=async(e,t)=>{const r=function(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t.buffer}(t);try{const t=await async function(){const e=await chrome.cookies.get({url:"https://api-dev.macro.com",name:"sessionId"});if(!e)throw new Error("sessionIdToken expired");const t=await fetch("https://api-dev.macro.com/graphql/",{method:"POST",headers:{"Content-Type":"application/json",Cookie:`${e.name}=${e.value}`},body:JSON.stringify({query:"\n    query userPermissions {\n      me {\n        __typename\n        id\n        permissions\n      }\n    }\n"})});if(!t.ok)throw new Error("graphql call did not succeeed");return(await t.json()).data.me.id}(),n={sha:await o(r),documentName:e,owner:t,fileType:"html"},{metadata:a,presignedUrl:s}=await async function(e){const t=await chrome.cookies.get({url:"https://macro.com",name:"macro-token"});if(!t)throw new Error("macroToken expired");const r=await fetch("https://cloud-storage-dev.macro.com/documents",{method:"POST",headers:{"Content-Type":"application/json",Cookie:`${t.name}=${t.value}`},body:JSON.stringify(e)});if(!r.ok)throw new Error("dss call did not succceed");const n=await r.json();return{metadata:n.data.documentMetadata,presignedUrl:n.data.presignedUrl}}(n);await async function(e,t,r){const n=new Blob([t],{type:r}),a=await o(t),s=btoa(a.match(/\w{2}/g).map((e=>String.fromCharCode(parseInt(e,16)))).join("")),d=await fetch(e,{method:"PUT",body:n,headers:{"Content-Type":i(r),"x-amz-checksum-sha256":s},signal:null});if(!d.ok){const e=await d.text();throw new Error(`Failed to upload file: ${e}`)}}(new URL(s),r,n.fileType);const d=`http://localhost:3000/app/html/${a.documentId}`;await chrome.tabs.create({url:d})}catch(e){console.error(e)}};chrome.runtime.onMessage.addListener(((e,t,r)=>{if("sendHtml"===e.action)return d(e.filename,e.content),!0}))}();
